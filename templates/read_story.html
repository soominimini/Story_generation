<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read Story - QTrobot</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 2rem auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 2rem; }
        h2 { color: #007bff; margin-bottom: 1rem; }
        .sentence { font-size: 1.3rem; color: #333; margin: 2rem 0; min-height: 3rem; }
        .image-container { text-align: center; margin: 1rem 0; }
        .story-image { max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px #0002; }
        .image-loading { color: #007bff; font-style: italic; }
        .btn { background: #007bff; color: #fff; border: none; padding: 0.7rem 2rem; border-radius: 5px; font-size: 1rem; cursor: pointer; margin: 0.5rem; }
        .btn:disabled { background: #aaa; cursor: not-allowed; }
        .btn.speak { background: #28a745; }
        .btn.speak:hover { background: #218838; }
        .meta { color: #888; font-size: 0.95rem; margin-bottom: 1rem; }
        
        .movement-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
            padding: 0.5rem;
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 8px;
            color: #155724;
            font-size: 0.9rem;
        }
        
        .movement-dot {
            width: 12px;
            height: 12px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        .progress { color: #007bff; font-size: 1rem; margin-bottom: 1rem; }
        .back-btn { background: #eee; color: #333; border: none; padding: 0.5rem 1.5rem; border-radius: 5px; font-size: 1rem; cursor: pointer; margin: 0.5rem; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
        <h2>Read Story with QTrobot</h2>
        <div class="meta" id="storyMeta"></div>
        <div class="progress" id="progress"></div>
        <div class="image-container" id="imageContainer">
            <div class="image-loading">üé® Generating image...</div>
        </div>
        <div class="sentence" id="sentence"></div>
        <div style="text-align: center;">
            <button class="btn speak" id="speakBtn" onclick="speakCurrentSentence()">üîä Speak Sentence</button>
            <button class="btn" id="nextBtn" onclick="nextSentence()">Next</button>
        </div>
        <div class="movement-indicator" id="movementIndicator" style="display: none;">
            <div class="movement-dot"></div>
            <span>ü§ñ Robot is moving while speaking...</span>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const filename = urlParams.get('filename') || window.location.pathname.split('/').pop();
        let sentences = [];
        let current = 0;
        let meta = {};
        let imagesAvailable = false;

        function fetchStory() {
            fetch(`/api/get_story_sentences?filename=${encodeURIComponent(filename)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        sentences = data.sentences;
                        meta = data.metadata || {};
                        imagesAvailable = data.images_available || false;
                        
                        document.getElementById('storyMeta').innerHTML =
                            `<b>Child:</b> ${meta.child_name || ''} &nbsp; <b>Age:</b> ${meta.age || ''} &nbsp; <b>Words:</b> ${meta.word_count || ''}`;
                        current = 0;
                        showSentence();
                    } else {
                        document.getElementById('sentence').innerHTML = 'Error loading story.';
                        document.getElementById('nextBtn').disabled = true;
                    }
                });
        }

        function showSentence() {
            if (sentences.length === 0) {
                document.getElementById('sentence').innerHTML = 'No story loaded.';
                document.getElementById('nextBtn').disabled = true;
                return;
            }
            
            document.getElementById('sentence').innerText = sentences[current] || '';
            document.getElementById('progress').innerText = `Sentence ${current+1} of ${sentences.length}`;
            document.getElementById('nextBtn').disabled = (current >= sentences.length-1);
            
            // Show image if available
            showImage();
        }

        function showImage() {
            const imageContainer = document.getElementById('imageContainer');
            
            if (!imagesAvailable) {
                imageContainer.innerHTML = '<div class="image-loading">üé® Image generation not available</div>';
                return;
            }
            
            // Show loading state
            imageContainer.innerHTML = '<div class="image-loading"><span class="loading-spinner"></span> Loading image...</div>';
            
            // Call API to get image for this sentence
            fetch('/api/get_sentence_image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    filename: filename,
                    sentence_index: current 
                })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Image API response:', data);
                if (data.success && data.image_path) {
                    console.log('Loading image from:', data.image_path);
                    imageContainer.innerHTML = `<img src="${data.image_path}" alt="Story scene" class="story-image" onerror="this.style.display='none'; console.log('Image failed to load:', data.image_path);" onload="console.log('Image loaded successfully:', data.image_path);">`;
                } else {
                    console.log('No image available:', data.error);
                    imageContainer.innerHTML = '<div class="image-loading">üé® No image available for this scene</div>';
                }
            })
            .catch(error => {
                console.log('Error loading image:', error);
                imageContainer.innerHTML = '<div class="image-loading">‚ùå Error loading image</div>';
            });
        }

        function nextSentence() {
            if (current < sentences.length-1) {
                current++;
                showSentence();
            }
        }

        function speakCurrentSentence() {
            if (sentences.length > 0 && current < sentences.length) {
                const sentence = sentences[current];
                const speakBtn = document.getElementById('speakBtn');
                const movementIndicator = document.getElementById('movementIndicator');
                
                // Visual feedback
                speakBtn.textContent = 'üîä Speaking...';
                speakBtn.disabled = true;
                
                // Show movement indicator
                movementIndicator.style.display = 'flex';
                
                fetch('/api/speak_sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sentence: sentence, filename: filename })
                })
                .then(() => {
                    // Reset button and hide movement indicator after a short delay
                    setTimeout(() => {
                        speakBtn.textContent = 'üîä Speak Sentence';
                        speakBtn.disabled = false;
                        movementIndicator.style.display = 'none';
                    }, 2000);
                })
                .catch(() => {
                    // Reset button and hide movement indicator on error
                    speakBtn.textContent = 'üîä Speak Sentence';
                    speakBtn.disabled = false;
                    movementIndicator.style.display = 'none';
                });
            }
        }

        function speakSentence(sentence) {
            fetch('/api/speak_sentence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sentence: sentence, filename: filename })
            });
        }

        window.onload = fetchStory;
    </script>
</body>
</html> 